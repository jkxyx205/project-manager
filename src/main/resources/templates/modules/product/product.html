<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="includes/base :: common_header(~{},~{::link},~{::style})">
    <link rel="stylesheet" th:href="@{/css/tab-common.css}">
    <link rel="stylesheet" th:href="@{/plugins/bootstrap-datepicker/css/bootstrap-datepicker.min.css}">
    <link rel="stylesheet" th:href="@{/plugins/multiple-select/multiple-select.min.css}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css"
    />

    <style>
        .form-check {
            display: inline-block!important;
        }

        .attachment .item {
            display: inline-block;
            position: relative;
        }

        .edit-table {
            width: auto;
        }

        .edit-table th,
        .edit-table td {
            padding: 0;
        }

        .edit-table input {
            width: 100%!important;
        }

        .sharp-form .form-control {
            width: 100%!important;
        }

        .form-inline .sharp-form label.col-form-label {
            display: block;
        }

        .sharp-form .required label:before, .sharp-form  label.required:before {
            left: 5px!important;
        }

        .operator.btn-link {
            padding: 0 15px;
        }

        .picture-container .item {
            margin-bottom: 15px;
        }

        /*[(${formBO.form.getAdditionalInfo['css'] == null ? '' : formBO.form.getAdditionalInfo['css']})]*/
    </style>
</head>
<body class="app">
<th:block th:replace="includes/base :: common_content(~{::div})">
    <div class="container-fluid" style="padding-bottom: 65px;">
        <div class="card">
            <div class="card-header">基本信息</div>
            <div class="card-body">
                <form class="form-inline row" id="t_product" name="t_product" onsubmit="return false">
                    <input type="hidden" id="id" th:value="${formBO.instanceId}">
                    <div class="form-group col-4">
                        <label class="col-form-label required" for="code">编号</label>
                        <input class="form-control" type="text" id="code" name="code" th:value="${formBO.data.code}" pattern="^[0-9a-zA-Z_/%-]{1,}$" th:disabled="${formBO.data.code}" required>
                    </div>
                    <div class="form-group col-8">
                        <label class="col-form-label required" for="name">品&nbsp;&nbsp;&nbsp;&nbsp;名</label>
                        <input class="form-control" type="text" id="name" name="name" th:value="${formBO.data.name}" required>
                    </div>
                    <div class="form-group col-4">
                        <label class="col-form-label required" for="category">分类</label>
                        <sp:select class="form-control" id="category" name="category" key="PRODUCT_TYPE" th:value="${formBO.data.category ne null ? formBO.data.category : ''}" required />
                    </div>
                    <div class="form-group col-4">
                        <label class="col-form-label required" for="supplier">供应商</label>
                        <sp:select class="form-control" id="supplier" name="supplier" key="sys_dict_supplier" th:value="${formBO.data.supplier ne null ? formBO.data.supplier : ''}" required />
                    </div>
                    <div class="form-group col-12">
                        <label class="col-form-label">参数</label>
                        <div style="flex: 1; padding: 15px; background-color: #e4e5e6;" th:id="${formBO.data['attrFormId']}">
                            <sp:form th:id="${formBO.data['attrFormId'] == null ? '864287608526680064' : formBO.data['attrFormId']}" th:value="${formBO.data['attrInstanceId']}" form-page="tpl/form/form-tag" hide-form-tag></sp:form>
                        </div>
                    </div>
                    <div class="form-group col-12">
                        <label class="col-form-label required" for="remark">备注</label>
                        <textarea class="form-control" id="remark" name="remark" th:text="${formBO.data.remark}" required></textarea>
                    </div>
                    <div class="form-group col-12">
                        <label class="col-form-label required">配件</label>
                        <table class="table edit-table accessoryList" id="accessoryList" name="accessoryList">
                            <thead>
                            <tr style="text-align: left;">
                                <th>
                                    <label class="col-form-label" style="display: block">名称</label>
                                </th>
                                <th>
                                    <label class="col-form-label" style="display: block">单价</label>
                                </th>
                                <th>
                                </th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="row : ${formBO.data.accessoryList}">
                                <td th:each="col: ${row}">
                                    <input type="text" class="form-control" th:value="${col}">
                                </td>
                                <td class="operator btn-link">X</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </form>
            </div>
        </div>
        <div class="card">
            <div class="card-header">产品图片
                <div style="display: inline-block;" id="btn-file">
                <label class="btn btn-primary btn-sm btn-upload" style="margin: 2px" for="pictures_file"><i class="fa fa-upload"></i> 上传</label>
            </div></div>
            <div class="card-body">
                <div class="picture-container">
                    <input style="display:none;" type="text" th:value="${formBO.data.pictures ne null ? T(com.rick.common.util.JsonUtils).toJson(formBO.data.pictures) : '[]'}">
                    <input style="display: none;" type="file" multiple name="pictures_file" id="pictures_file" accept="image/*" data-group-name="pictures" onchange="t_product_pictures_file.ajaxFileUpload()">
                    <div class="attachment-items row">
                        <th:block th:if="${formBO.data.pictures ne null}">
                            <div class="item col-12 col-md-2" style="position: relative" th:each="f : ${formBO.data.pictures}">
                                <a class="picture" style="display: block; padding: 4px; border: 1px solid #e3e3c7" data-fancybox="picture" th:attr="data-src=${f.url}, data-caption=${f.fullName}">
                                    <img th:src="${f.url}" th:alt="${f.fullName}" style="width: 100%;">
                                </a>
                                <a class="attachment_delete_btn" style="position: absolute; right: 4px; top: 0;" href="javascript:;" th:onclick="t_product_pictures_file.deleteAttachment([[${f.id}]], this)">X</a>
                            </div>
                        </th:block>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div style="position: fixed; left: 0; bottom: 0; width: 100%; padding: 15px; border-top: 1px solid #c8ced3; background-color: #FFFFFF; text-align: center">
        <button type="button" class="btn btn-primary btn-save" th:onclick="[(${formBO.form.code})]FormDOM.save()">保存</button>
    </div>
</th:block>
<th:block th:replace="includes/base :: common_js(~{::script})">
    <script type="text/javascript" th:src="@{/plugins/jquery.form2json.js}"></script>

    <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"></script>

    <script th:src="@{/plugins/ajaxfileupload.js}"></script>
    <script th:src="@{/js/upload.js}"></script>

    <script th:src="@{/plugins/bootstrap-datepicker/js/bootstrap-datepicker.min.js}"></script>
    <script th:src="@{/plugins/bootstrap-datepicker/js/bootstrap-datepicker.zh-CN.min.js}"></script>
    <script th:src="@{/plugins/multiple-select/multiple-select.min.js}"></script>
    <script th:src="@{/editable-table/editable-table.js}"></script>

    <script th:src="@{/js/form-support.js}"></script>
    <script th:inline="javascript">
        let formBO = /*[[${ formBO }]]*/
        let originalFormData = /*[[${ formBO.data }]]*/
        let formCode = /*[[${formBO.form.code}]]*/
        let codeDOM = document.getElementById("code")
        let p = [[${formBO.propertyList}]]

        hasAuthority = true
        let readonly = !hasAuthority || [[${query.readonly}]]

        let formDOM = window[formCode + 'FormDOM'] = document.forms[0]
        sharpFormInit(formDOM, document.getElementById("id"), {originalFormData, formCode, p,readonly, actionUrl: formBO.actionUrl, method: formBO.method}, null, null);

        $('.btn-save').removeAttr("onclick").on('click', function () {
            if (t_productFormDOM.valid()) {
                washFormDOM.save(res => {
                    if (res.success) {
                        t_productFormDOM.save((res) => {
                            codeDOM.setAttribute("disabled", "true")
                            toastr.success("保存成功")
                        }, formData => {
                            formData.attrInstanceId = res.data
                            formData.pictures = t_product_pictures_file.getAttachments();
                        })
                    }
                }, formData => {
                    $('.sharp-form input').each(function () {
                        formData[this.id] = this.value
                    })
                })
            }

        })

        function t_product_pictures_file_itemSupplier(attachment) {
            return "<div class=\"item col-12 col-md-2\">\n" +
                "    <a class=\"picture\" style=\"display: block; padding: 4px; border: 1px solid #e3e3c7\" data-fancybox=\"picture\" data-src=\""+attachment.url+"\" data-caption=\""+attachment.fullName+"\">\n" +
                "        <img src=\""+attachment.url+"\" th:alt=\""+attachment.fullName+"\" style=\"width: 100%;\">\n" +
                "    </a>\n" +
                "    <a class=\"attachment_delete_btn\" style=\"position: absolute; right: 4px; top: 0;\" href=\"javascript:;\" onclick=\"t_product_pictures_file.deleteAttachment('"+attachment.id+"', this)\">X</a>" +
                "</div>";
        }

        Fancybox.bind('a.picture', {});

        /*[(${formBO.form.getAdditionalInfo['js'] == null ? '' : formBO.form.getAdditionalInfo['js']})]*/
    </script>
</th:block>
</body>
</html>